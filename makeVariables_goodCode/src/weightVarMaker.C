#include <TFile.h>
#include <TCanvas.h>

#include "../include/weightVarMaker.h"
#include "../include/variablesFunctions.h"
#include "../include/inputMap_MV.h"
#include "../../myLibrary/commenFunction.h"
#include "../../inputFiles/genSumMap.h"//use this for accessing genSum for each process instead

WeightVarMaker::WeightVarMaker(TTree *outTree, TString era, Bool_t isData, const Bool_t isRun3, const TString processName): m_era{era}, m_isData{isData}, m_isRun3{isRun3}, m_processName{processName}
{
    std::cout << "Initializing WeightVarMaker.....\n";
    std::cout<<"m_era="<<m_era<<" m_isData="<<m_isData<<" m_isRun3="<<m_isRun3<<"\n";

    outTree->Branch("EVENT_prefireWeight", &EVENT_prefireWeight);
    outTree->Branch("EVENT_prefireWeight_up", &EVENT_prefireWeight_up);
    outTree->Branch("EVENT_prefireWeight_down", &EVENT_prefireWeight_down);
    outTree->Branch("EVENT_genWeight", &EVENT_genWeight);
    outTree->Branch("PUweight_", &PUweight_);
    outTree->Branch("PUweight_up_", &PUweight_up_);
    outTree->Branch("PUweight_down_", &PUweight_down_);
    outTree->Branch("btagEfficiency_weight", &btagEfficiency_weight);
    outTree->Branch("muonIDSF_weight", &muonIDSF_weight);
    outTree->Branch("muonIDSF_weight_up", &muonIDSF_weight_up);
    outTree->Branch("muonIDSF_weight_down", &muonIDSF_weight_down);
    outTree->Branch("mounTrackerSF_weight", &mounTrackerSF_weight);
    outTree->Branch("eleMVAT_IDSF_weight", &eleMVAT_IDSF_weight);
    outTree->Branch("eleMVAT_IDSF_weight_up", &eleMVAT_IDSF_weight_up);
    outTree->Branch("eleMVAT_IDSF_weight_down", &eleMVAT_IDSF_weight_down);
    outTree->Branch("eleMVAT_IDSF_weight_backup", &eleMVAT_IDSF_weight_backup);
    outTree->Branch("elesTopMVAT_weight", &elesTopMVAT_weight);
    outTree->Branch("elesTopMVAT_weight_up", &elesTopMVAT_weight_up);
    outTree->Branch("elesTopMVAT_weight_down", &elesTopMVAT_weight_down);
    outTree->Branch("musTopMVAT_weight", &musTopMVAT_weight);
    outTree->Branch("musTopMVAT_weight_up", &musTopMVAT_weight_up);
    outTree->Branch("musTopMVAT_weight_down", &musTopMVAT_weight_down);
    outTree->Branch("musTopMVAT_weight_sys_up", &musTopMVAT_weight_sys_up);
    outTree->Branch("musTopMVAT_weight_sys_down", &musTopMVAT_weight_sys_down);
    outTree->Branch("musTopMVAT_weight_stat_up", &musTopMVAT_weight_stat_up);
    outTree->Branch("musTopMVAT_weight_stat_down", &musTopMVAT_weight_stat_down);
    outTree->Branch("elesTopMVAT_weight_sys_up", &elesTopMVAT_weight_sys_up);
    outTree->Branch("elesTopMVAT_weight_sys_down", &elesTopMVAT_weight_sys_down);
    outTree->Branch("elesTopMVAT_weight_stat_up", &elesTopMVAT_weight_stat_up);
    outTree->Branch("elesTopMVAT_weight_stat_down", &elesTopMVAT_weight_stat_down);
    outTree->Branch("elesTopMVAT_weight_new", &elesTopMVAT_weight_new);
    outTree->Branch("musTopMVAT_weight_new", &musTopMVAT_weight_new);


    outTree->Branch("tauT_IDSF_weight_new", &tauT_IDSF_weight_new);
    outTree->Branch("tauTT_IDSF_weight_new", &tauTT_IDSF_weight_new);
    outTree->Branch("tauT_IDSF_weight_new_vsjet_up", &tauT_IDSF_weight_new_vsjet_up);
    outTree->Branch("tauT_IDSF_weight_new_vsjet_down", &tauT_IDSF_weight_new_vsjet_down);
    outTree->Branch("tauT_IDSF_weight_new_vsmu_up", &tauT_IDSF_weight_new_vsmu_up);
    outTree->Branch("tauT_IDSF_weight_new_vsmu_down", &tauT_IDSF_weight_new_vsmu_down);
    outTree->Branch("tauT_IDSF_weight_new_vsele_up", &tauT_IDSF_weight_new_vsele_up);
    outTree->Branch("tauT_IDSF_weight_new_vsele_down", &tauT_IDSF_weight_new_vsele_down);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm0_up", &tauT_IDSF_weight_new_stat1_dm0_up);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm0_down", &tauT_IDSF_weight_new_stat1_dm0_down);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm1_up", &tauT_IDSF_weight_new_stat1_dm1_up);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm1_down", &tauT_IDSF_weight_new_stat1_dm1_down);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm10_up", &tauT_IDSF_weight_new_stat1_dm10_up);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm10_down", &tauT_IDSF_weight_new_stat1_dm10_down);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm11_up", &tauT_IDSF_weight_new_stat1_dm11_up);
    outTree->Branch("tauT_IDSF_weight_new_stat1_dm11_down", &tauT_IDSF_weight_new_stat1_dm11_down);

    outTree->Branch("tauT_IDSF_weight_new_stat2_dm0_up", &tauT_IDSF_weight_new_stat2_dm0_up);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm0_down", &tauT_IDSF_weight_new_stat2_dm0_down);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm1_up", &tauT_IDSF_weight_new_stat2_dm1_up);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm1_down", &tauT_IDSF_weight_new_stat2_dm1_down);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm10_up", &tauT_IDSF_weight_new_stat2_dm10_up);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm10_down", &tauT_IDSF_weight_new_stat2_dm10_down);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm11_up", &tauT_IDSF_weight_new_stat2_dm11_up);
    outTree->Branch("tauT_IDSF_weight_new_stat2_dm11_down", &tauT_IDSF_weight_new_stat2_dm11_down);


    outTree->Branch("tauT_IDSF_weight_new_syst_alleras_up", &tauT_IDSF_weight_new_syst_alleras_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_alleras_down", &tauT_IDSF_weight_new_syst_alleras_down);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_up", &tauT_IDSF_weight_new_syst_era_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_down", &tauT_IDSF_weight_new_syst_era_down);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm0_up", &tauT_IDSF_weight_new_syst_era_dm0_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm0_down", &tauT_IDSF_weight_new_syst_era_dm0_down);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm1_up", &tauT_IDSF_weight_new_syst_era_dm1_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm1_down", &tauT_IDSF_weight_new_syst_era_dm1_down);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm10_up", &tauT_IDSF_weight_new_syst_era_dm10_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm10_down", &tauT_IDSF_weight_new_syst_era_dm10_down);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm11_up", &tauT_IDSF_weight_new_syst_era_dm11_up);
    outTree->Branch("tauT_IDSF_weight_new_syst_era_dm11_down", &tauT_IDSF_weight_new_syst_era_dm11_down);


    outTree->Branch("btagShape_weight", &btagShape_weight);
    outTree->Branch("btagShape_weight_jes_up", &btagShape_weight_jes_up);
    outTree->Branch("btagShape_weight_jes_down", &btagShape_weight_jes_down);
    outTree->Branch("btagShape_weight_hf_up", &btagShape_weight_hf_up);
    outTree->Branch("btagShape_weight_hf_down", &btagShape_weight_hf_down);
    outTree->Branch("btagShape_weight_lf_up", &btagShape_weight_lf_up);
    outTree->Branch("btagShape_weight_lf_down", &btagShape_weight_lf_down);
    outTree->Branch("btagShape_weight_hfstats1_up", &btagShape_weight_hfstats1_up);
    outTree->Branch("btagShape_weight_hfstats1_down", &btagShape_weight_hfstats1_down);
    outTree->Branch("btagShape_weight_hfstats2_up", &btagShape_weight_hfstats2_up);
    outTree->Branch("btagShape_weight_hfstats2_down", &btagShape_weight_hfstats2_down);
    outTree->Branch("btagShape_weight_lfstats1_up", &btagShape_weight_lfstats1_up);
    outTree->Branch("btagShape_weight_lfstats1_down", &btagShape_weight_lfstats1_down);
    outTree->Branch("btagShape_weight_lfstats2_up", &btagShape_weight_lfstats2_up);
    outTree->Branch("btagShape_weight_lfstats2_down", &btagShape_weight_lfstats2_down);
    outTree->Branch("btagShape_weight_cferr1_up", &btagShape_weight_cferr1_up);
    outTree->Branch("btagShape_weight_cferr1_down", &btagShape_weight_cferr1_down);
    outTree->Branch("btagShape_weight_cferr2_up", &btagShape_weight_cferr2_up);
    outTree->Branch("btagShape_weight_cferr2_down", &btagShape_weight_cferr2_down);
    outTree->Branch("btagShapeR", &btagShapeR);
    //
    outTree->Branch("btagWPMedium_weight", &btagWPMedium_weight);
    outTree->Branch("btagWPMedium_weight_up", &btagWPMedium_weight_up);
    outTree->Branch("btagWPMedium_weight_down", &btagWPMedium_weight_down);
    outTree->Branch("btagWPMT_weight", &btagWPMT_weight);
    outTree->Branch("btagWPMT_weight_up", &btagWPMT_weight_up);
    outTree->Branch("btagWPMT_weight_down", &btagWPMT_weight_down);
    outTree->Branch("btagWPMT_weight_correlated_up", &btagWPMT_weight_correlated_up);
    outTree->Branch("btagWPMT_weight_correlated_down", &btagWPMT_weight_correlated_down);
    outTree->Branch("btagWPMT_weight_uncorrelated_up", &btagWPMT_weight_uncorrelated_up);
    outTree->Branch("btagWPMT_weight_uncorrelated_down", &btagWPMT_weight_uncorrelated_down);

    outTree->Branch("HLT_weight", &HLT_weight);
    outTree->Branch("HLT_weight_stats_up", &HLT_weight_stats_up);
    outTree->Branch("HLT_weight_stats_down", &HLT_weight_stats_down);
    outTree->Branch("FR_weight", &FR_weight);
    outTree->Branch("FR_weight_up", &FR_weight_up);
    outTree->Branch("FR_weight_down", &FR_weight_down);

    outTree->Branch("global_weight", &global_weight);

    //theory weight
    outTree->Branch("pdfWeight_up_", &pdfWeight_up_);
    outTree->Branch("pdfWeight_down_", &pdfWeight_down_);
    outTree->Branch("pdfWeightAlphaS_up_", &pdfWeightAlphaS_up_);
    outTree->Branch("pdfWeightAlphaS_down_", &pdfWeightAlphaS_down_);
    outTree->Branch("scaleWeight_up_", &scaleWeight_up_);
    outTree->Branch("scaleWeight_down_", &scaleWeight_down_);
    outTree->Branch("scaleWeightRe_up_", &scaleWeightRe_up_);
    outTree->Branch("scaleWeightRe_down_", &scaleWeightRe_down_);
    outTree->Branch("scaleWeightFa_up_", &scaleWeightFa_up_);
    outTree->Branch("scaleWeightFa_down_", &scaleWeightFa_down_);
    outTree->Branch("PSWeightISR_up_", &PSWeightISR_up_);
    outTree->Branch("PSWeightISR_down_", &PSWeightISR_down_);
    outTree->Branch("PSWeightFSR_up_", &PSWeightFSR_up_);
    outTree->Branch("PSWeightFSR_down_", &PSWeightFSR_down_);


    // TOP Lepton MVA
    eleIDSF_topMVA = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(0), "EGamma_SF2D");
    muIDSF_topMVA = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(1), "NUM_LeptonMvaMedium_DEN_TrackerMuons_abseta_pt");
    eleIDSF_topMVA_stat = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(0), "stat");
    eleIDSF_topMVA_sys = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(0), "sys");//n the sys and stat histograms, the bincontent is the uncertainty you want, so you can just extract that. So example, the systematic up variation of the electron SF: EGamma_SF2D->GetBinContent(x, y) * (1. + sys->GetBinContent(x, y)).
    muIDSF_topMVA_sys = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(1), "NUM_LeptonMvaMedium_DEN_TrackerMuons_abseta_pt_combined_syst");
    muIDSF_topMVA_stat = TTTT::getHistogramFromFile<TH2D>(MV::topLeptonSF_files.at(m_era).at(1), "NUM_LeptonMvaMedium_DEN_TrackerMuons_abseta_pt_stat"); // the errors are stored in the errors of the histograms, so an example code line becomes: nominal->GetBinContent(x, y) * (1. + sys->GetBinError(x, y))

    //muon 2022 SFs
    TString base = "../../jsonpog-integration/POG/";
    TString muonSF_json = base + MV::json_muon2022.at(m_era).at(0); 
    std::cout<<"muonSF low Pt json="<<muonSF_json<<"\n";
    std::cout<<"muonSF medium Pt json="<<base + MV::json_muon2022.at(m_era).at(1)<<"\n";
    std::cout<<"muonSF high Pt json="<<base + MV::json_muon2022.at(m_era).at(2)<<"\n";
    cset_muonLPt = correction::CorrectionSet::from_file( (base + MV::json_muon2022.at(m_era).at(0)).Data()); 
    cset_muonMPt = correction::CorrectionSet::from_file( (base + MV::json_muon2022.at(m_era).at(1)).Data()); 
    cset_muonHPt = correction::CorrectionSet::from_file( (base + MV::json_muon2022.at(m_era).at(2)).Data()); 
    std::cout << "\n";

    // new SF files from
    TString tauSF_json = base + MV::json_map.at(m_era).at(1);
    TString btagSF_json = base + MV::json_map.at(m_era).at(2);
    std::cout<<"tauSF json="<<tauSF_json<<"\n";
    std::cout << "btagSF_json=" << btagSF_json << "\n";
    cset = correction::CorrectionSet::from_file(tauSF_json.Data());//for tau
    cset_btag = correction::CorrectionSet::from_file(btagSF_json.Data());
    m_eraForTau = m_era.Contains("2016") ?  m_era.ReplaceAll("2016P", "2016_p"): m_era;
    // btagR files
    btagRHist = TTTT::getHistogramFromFile<TH1D>(MV::btagR_map.at(m_era), "btagR");
    std::cout << "b tag R file used: " << MV::btagR_map.at(m_era) << "\n";

    //btag WP efficieny files
    btagEffHist_b = TTTT::getHistogramFromFile<TH2D>(MV::btagWPEff_map.at(m_era)+"bEff_B.root", "jets_ptEta_genB");
    btagEffHist_c = TTTT::getHistogramFromFile<TH2D>(MV::btagWPEff_map.at(m_era)+"bEff_C.root", "jets_ptEta_genC");
    btagEffHist_l = TTTT::getHistogramFromFile<TH2D>(MV::btagWPEff_map.at(m_era)+"bEff_L.root", "jets_ptEta_genL");
    std::cout << "b tag WP file used: " << MV::btagWPEff_map.at(m_era) << "\n";

    btagTEffHist_b = TTTT::getHistogramFromFile<TH2D>(MV::btagWPTEff_map.at(m_era)+"bEff_B.root", "jets_ptEta_genB");
    btagTEffHist_c = TTTT::getHistogramFromFile<TH2D>(MV::btagWPTEff_map.at(m_era)+"bEff_C.root", "jets_ptEta_genC");
    btagTEffHist_l = TTTT::getHistogramFromFile<TH2D>(MV::btagWPTEff_map.at(m_era)+"bEff_L.root", "jets_ptEta_genL");
    std::cout<<"b tag Tight WP used: "<<MV::btagWPTEff_map.at(m_era)<<"\n";
    std::cout<<"\n";

    // trigger
    TString triggerSFdir = MV::triggerSF_map.at(m_era);
    triggerHist1b = TTTT::getHistogramFromFile<TH2D>(triggerSFdir +"baseline1Muon4b_triggerSF_v0.root", "singleMu_SF");
    triggerHist2b = TTTT::getHistogramFromFile<TH2D>(triggerSFdir +"baseline1Muon2b_triggerSF_v0.root", "singleMu_SF");
    triggerHist3b = TTTT::getHistogramFromFile<TH2D>(triggerSFdir +"baseline1Muon3b_triggerSF_v0.root", "singleMu_SF");
    std::cout<<"trigger SF: "<<triggerSFdir<<"\n\n";

    //get FR
    TFile *file = new TFile(MV::FR_mapNew.at(m_era), "READ");
    std::cout<<"FR files used: "<<file->GetName()<<"\n"<<file->GetName()<<"\n";
    // Assuming these graphs are already created and stored in the ROOT file
    m_graphs.emplace_back(0.0, 0.8, 1, dynamic_cast<TGraphAsymmErrors*>(file->Get("fakeRate_Eta1Prong1")));
    m_graphs.emplace_back(0.8, 1.5, 1, dynamic_cast<TGraphAsymmErrors*>(file->Get("fakeRate_Eta2Prong1")));
    m_graphs.emplace_back(1.5, 2.7, 1, dynamic_cast<TGraphAsymmErrors*>(file->Get("fakeRate_Eta3Prong1")));
    m_graphs.emplace_back(0.0, 2.7, 3, dynamic_cast<TGraphAsymmErrors*>(file->Get("fakeRate_EtaAllProng3"))); //!3 is not 3 but not 1
    // m_graphs.emplace_back(0.8, 1.5, 3, dynamic_cast<TGraphAsymmErrors*>(file3Prong->Get("fakeRate_Eta2")));
    // m_graphs.emplace_back(1.5, 2.7, 3, dynamic_cast<TGraphAsymmErrors*>(file3Prong->Get("fakeRate_Eta3")));

    if(!m_isData){
        if(m_processName.Contains("TTToSemiLeptonic") || m_processName.Contains("TTTo2L2Nu") || m_processName.Contains("TTToHadronic")){//!TT extra processes have to be added to use later
            TString processTem = removeTrailingNumbers(m_processName);
            std::cout<<"processTem="<<processTem<<"\n";
            global_weight = TTTT::lumiMap.at(m_era) * TTTT::crossSectionMap.at(processTem) / GENSUM::genSumMap.at(m_era).at(processTem);
            std::cout<<"lumi="<<TTTT::lumiMap.at(m_era)<<" crossSection="<<TTTT::crossSectionMap.at(processTem)<<" genSum="<<GENSUM::genSumMap.at(m_era).at(processTem)<<"\n";
        }else{
            global_weight = TTTT::lumiMap.at(m_era) * TTTT::crossSectionMap.at(m_processName) / GENSUM::genSumMap.at(m_era).at(m_processName);//!only BDT training uses this
            std::cout<<"lumi="<<TTTT::lumiMap.at(m_era)<<" crossSection="<<TTTT::crossSectionMap.at(m_processName)<<" genSum="<<GENSUM::genSumMap.at(m_era).at(m_processName)<<"\n";
        }
        std::cout<<"global_weight="<<global_weight<<"\n";
    }

    std::cout << "Done initializing ............\n";
    std::cout << "\n";
};

// void WeightVarMaker::makeVariables(EventForMV *e, const Double_t jets_HT,  Double_t jets_6pt, const Int_t jets_num, const Int_t bjetsM_num)
void WeightVarMaker::makeVariables(EventForMV *e, const Double_t jets_HT,  Double_t jets_6pt, const Int_t jets_num, const Int_t bjetsM_num, const JetVarMaker* jetVarMaker)
{
    reportEntry("WeightVarMaker::makeVariables()");
    clearBranch();

    EVENT_prefireWeight = *e->EVENT_prefireWeight_;
    EVENT_prefireWeight_up = *e->EVENT_prefireWeight_up_;
    EVENT_prefireWeight_down = *e->EVENT_prefireWeight_down_;
    EVENT_genWeight = *e->EVENT_genWeight_;
    PUweight_ = *e->PUWeight;
    PUweight_up_ = *e->PUWeight_up;
    PUweight_down_ = *e->PUWeight_down;

    //copy
    pdfWeight_up_ = *e->pdfWeight_up;
    pdfWeight_down_ = *e->pdfWeight_down;
    pdfWeightAlphaS_up_ = *e->pdfWeightAlphaS_up;
    pdfWeightAlphaS_down_ = *e->pdfWeightAlphaS_down;
    scaleWeight_up_ = *e->scaleWeight_up;
    scaleWeight_down_ = *e->scaleWeight_down;
    scaleWeightRe_up_ = *e->scaleWeightRe_up;
    scaleWeightRe_down_ = *e->scaleWeightRe_down;
    scaleWeightFa_up_ = *e->scaleWeightFa_up;
    scaleWeightFa_down_ = *e->scaleWeightFa_down;
    // PSWeight_up_ = *e->PSWeight_up;
    // PSWeight_down_ = *e->PSWeight_down;
    PSWeightISR_up_ = *e->PSWeightISR_up;
    PSWeightISR_down_ = *e->PSWeightISR_down;
    PSWeightFSR_up_ = *e->PSWeightFSR_up;
    PSWeightFSR_down_ = *e->PSWeightFSR_down;

    // lepton SF for top mva leptons
    elesTopMVAT_weight = calMuonIDSF(e->elesTopMVAT_pt, e->elesTopMVAT_eta, eleIDSF_topMVA, 0, kFALSE, m_isData); //muon pt and eta
    elesTopMVAT_weight_up = calMuonIDSF(e->elesTopMVAT_pt, e->elesTopMVAT_eta, eleIDSF_topMVA, 1, kFALSE, m_isData);
    elesTopMVAT_weight_down = calMuonIDSF(e->elesTopMVAT_pt, e->elesTopMVAT_eta, eleIDSF_topMVA, 2, kFALSE, m_isData);
    musTopMVAT_weight = calMuonIDSF(e->muonsTopMVAT_pt, e->muonsTopMVAT_eta, muIDSF_topMVA, 0, kTRUE, m_isData);
    musTopMVAT_weight_up = calMuonIDSF(e->muonsTopMVAT_pt, e->muonsTopMVAT_eta, muIDSF_topMVA, 1, kTRUE, m_isData);
    musTopMVAT_weight_down = calMuonIDSF(e->muonsTopMVAT_pt, e->muonsTopMVAT_eta, muIDSF_topMVA, 2, kTRUE, m_isData);
    musTopMVAT_weight_sys_up = calMuonIDSF_independentSys(muIDSF_topMVA, muIDSF_topMVA_sys, e->muonsTopMVAT_eta, e->muonsTopMVAT_pt, 1, kTRUE, m_isData, kFALSE); 
    musTopMVAT_weight_sys_down = calMuonIDSF_independentSys(muIDSF_topMVA, muIDSF_topMVA_sys, e->muonsTopMVAT_eta, e->muonsTopMVAT_pt, 2, kTRUE, m_isData, kFALSE);
    musTopMVAT_weight_stat_up = calMuonIDSF_independentSys(muIDSF_topMVA, muIDSF_topMVA_stat, e->muonsTopMVAT_eta, e->muonsTopMVAT_pt, 1, kTRUE, m_isData, kTRUE);
    musTopMVAT_weight_stat_down = calMuonIDSF_independentSys(muIDSF_topMVA, muIDSF_topMVA_stat, e->muonsTopMVAT_eta, e->muonsTopMVAT_pt, 2, kTRUE, m_isData, kTRUE);
    elesTopMVAT_weight_sys_up = calMuonIDSF_independentSys(eleIDSF_topMVA, eleIDSF_topMVA_sys,  e->elesTopMVAT_eta, e->elesTopMVAT_pt, 1, kFALSE, m_isData, kFALSE );
    elesTopMVAT_weight_sys_down = calMuonIDSF_independentSys(eleIDSF_topMVA, eleIDSF_topMVA_sys,  e->elesTopMVAT_eta, e->elesTopMVAT_pt, 2, kFALSE, m_isData, kFALSE);
    elesTopMVAT_weight_stat_up = calMuonIDSF_independentSys(eleIDSF_topMVA, eleIDSF_topMVA_stat,  e->elesTopMVAT_eta, e->elesTopMVAT_pt, 1, kFALSE, m_isData, kFALSE);
    elesTopMVAT_weight_stat_down = calMuonIDSF_independentSys(eleIDSF_topMVA, eleIDSF_topMVA_stat,  e->elesTopMVAT_eta, e->elesTopMVAT_pt, 2, kFALSE, m_isData, kFALSE);
    elesTopMVAT_weight_new = calMuonIDSF_independentSys(eleIDSF_topMVA, eleIDSF_topMVA_stat,  e->elesTopMVAT_eta, e->elesTopMVAT_pt, 0, kFALSE, m_isData, kTRUE);
    musTopMVAT_weight_new = calMuonIDSF_independentSys(muIDSF_topMVA, muIDSF_topMVA_stat,  e->muonsTopMVAT_eta, e->muonsTopMVAT_pt, 0, kTRUE, m_isData, kTRUE);
    //!!!normal leptons
    eleMVAT_IDSF_weight = calMuonIDSF(e->elesMVAT_pt, e->elesMVAT_eta, eleIDSF_topMVA, 0, kFALSE, m_isData);
    eleMVAT_IDSF_weight_up = calMuonIDSF(e->elesMVAT_pt, e->elesMVAT_eta, eleIDSF_topMVA, 1, kFALSE, m_isData);
    eleMVAT_IDSF_weight_down = calMuonIDSF(e->elesMVAT_pt, e->elesMVAT_eta, eleIDSF_topMVA, 2, kFALSE, m_isData);

    //sf for run3 muonPOG ID and ISO        
    //!!!suspect this is causing the run time error:  what():  Index above bounds in Binning for input argument 1 value: 1064.129272
    muonIDSF_weight = calMuonIDSF_json(e->muonsT_eta, e->muonsT_pt, cset_muonLPt.get(), cset_muonMPt.get(), cset_muonHPt.get(), 0, m_isData);//!!!check input muon collection
    muonIDSF_weight_up = calMuonIDSF_json(e->muonsT_eta, e->muonsT_pt, cset_muonLPt.get(), cset_muonMPt.get(), cset_muonHPt.get(), 1, m_isData);//!!!check input muon collection
    muonIDSF_weight_down = calMuonIDSF_json(e->muonsT_eta, e->muonsT_pt, cset_muonLPt.get(), cset_muonMPt.get(), cset_muonHPt.get(), 2, m_isData);//!!!check input muon collection

    tauT_IDSF_weight_new = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "nom", "nom", "nom",  "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_vsjet_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "up", "nom", "nom", "Medium", m_isData, m_isRun3);//!for 'dm' systematic, the up and down are the same as nominal
    tauT_IDSF_weight_new_vsjet_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_vsmu_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "nom", "up", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_vsmu_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "nom", "down", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_vsele_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "nom", "nom", "up", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_vsele_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "nom", "nom", "down", "Medium", m_isData, m_isRun3);
    tauTT_IDSF_weight_new = calTau_IDSF_new(e->tausTT_pt, e->tausTT_eta, e->tausTT_decayMode, e->tausTT_genPartFlav, cset.get(), "nom", "nom", "nom",  "Tight", m_isData, m_isRun3);
    //handling of tau systematic uncertainties properly 
    tauT_IDSF_weight_new_stat1_dm0_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm0_up", "nom", "nom", "Medium", m_isData, m_isRun3);//!detailed sytematic uncertainties only available for tauVsJet
    tauT_IDSF_weight_new_stat1_dm0_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm0_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm1_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm1_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm1_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm1_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm10_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm10_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm10_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm10_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm11_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm11_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat1_dm11_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat1_dm11_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm0_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm0_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm0_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm0_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm1_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm1_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm1_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm1_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm10_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm10_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm10_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm10_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm11_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm11_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_stat2_dm11_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "stat2_dm11_down", "nom", "nom", "Medium", m_isData, m_isRun3);


    tauT_IDSF_weight_new_syst_alleras_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "syst_alleras_up", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_alleras_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), "syst_alleras_down", "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_up").Data(), "nom", "nom", "Medium", m_isData, m_isRun3); //! care for 2016; era=2016_preVFP, 2016_postVFP, 2017, 2018
    tauT_IDSF_weight_new_syst_era_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_down").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm0_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm0_up").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm0_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm0_down").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm1_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm1_up").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm1_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm1_down").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm10_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm10_up").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm10_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm10_down").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm11_up = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm11_up").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);
    tauT_IDSF_weight_new_syst_era_dm11_down = calTau_IDSF_new(e->tausT_pt, e->tausT_eta, e->tausT_decayMode, e->tausT_genPartFlav, cset.get(), ("syst_" + m_eraForTau + "_dm11_down").Data(), "nom", "nom", "Medium", m_isData, m_isRun3);

    //!!!Todo: here it really speaks for the importance of encapsulated object class
    TTreeReaderArray<Double_t>& jets_btags = e->jets_btags;
    std::vector<Double_t> jets_pt = jetVarMaker->getJetsPt_vec(); //corrected removed low pt jets
    std::vector<Double_t> jets_eta = jetVarMaker->getJetsEta_vec();
    std::vector<Int_t> jets_flavour = jetVarMaker->getJetsFlavour_vec(e->jets_flavour);
    std::vector<Double_t> jets_btags_vec = jetVarMaker->getJetsBtags_vec();
    btagShape_weight = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "central");
    btagShape_weight_jes_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_jes");//!!!should we use this btagShape weight for JES variation? Also the input here has the problem of pt cut at 22 GeV
    //!!!yes: For each JES source used in your analysis, the respective up/down_jesXXX varied SF is to be applied to the JES-varied template instead of the nominal one
    btagShape_weight_jes_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_jes");
    btagShape_weight_lf_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_lf");
    btagShape_weight_lf_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_lf");
    btagShape_weight_hf_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_hf");
    btagShape_weight_hf_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_hf");
    btagShape_weight_hfstats1_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_hfstats1");
    btagShape_weight_hfstats1_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_hfstats1");
    btagShape_weight_hfstats2_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_hfstats2");
    btagShape_weight_hfstats2_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_hfstats2");
    btagShape_weight_lfstats1_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_lfstats1");
    btagShape_weight_lfstats1_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_lfstats1");
    btagShape_weight_lfstats2_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_lfstats2");
    btagShape_weight_lfstats2_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_lfstats2");
    btagShape_weight_cferr1_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_cferr1");
    btagShape_weight_cferr1_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_cferr1");
    btagShape_weight_cferr2_up = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "up_cferr2");
    btagShape_weight_cferr2_down = calBtagShapeWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), m_isData, "down_cferr2");
    // btagShapeR = calBtagR(e->jets_pt.GetSize(), btagRHist); //!!!When JES variation, the btagR is to be varied as well
    btagShapeR = calBtagR(jets_num, btagRHist); //!!!When JES variation, the btagR is to be varied as well
    //!For each JES source used in your analysis the respective up/down_jesXXX varied SF is to be applied to the JES-varied template instead of the nominal one

    //btag WorkingPoint
    //!!!Not sure if we should vary the BtagWP weight for JES variation as well
    btagWPMedium_weight = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "central", m_isRun3);
    btagWPMedium_weight_up = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l, btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "up", m_isRun3) ;
    btagWPMedium_weight_down = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l, btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "down", m_isRun3) ;
    btagWPMT_weight = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "central", m_isRun3, kTRUE);
    btagWPMT_weight_up = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "up", m_isRun3, kTRUE);
    btagWPMT_weight_down = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "down", m_isRun3, kTRUE);
    if(std::isnan(btagWPMT_weight) || std::isinf(btagWPMT_weight)){
        std::cout<<"btagWPMT_weight="<<btagWPMT_weight<<"\n";
    }//!
    btagWPMT_weight_correlated_up = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "up_correlated", m_isRun3, kTRUE);
    btagWPMT_weight_correlated_down = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "down_correlated", m_isRun3, kTRUE);
    btagWPMT_weight_uncorrelated_up = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "up_uncorrelated", m_isRun3, kTRUE);
    btagWPMT_weight_uncorrelated_down = calBtagWPMWeight(e->jets_pt, e->jets_eta, e->jets_flavour, jets_btags, cset_btag.get(), btagEffHist_b, btagEffHist_c, btagEffHist_l,  btagTEffHist_b, btagTEffHist_l, btagTEffHist_c, m_isData, m_era, "down_uncorrelated", m_isRun3, kTRUE);


    HLT_weight = HLTWeightCal(jets_HT, jets_6pt, bjetsM_num, triggerHist1b, triggerHist2b, triggerHist3b, m_isData, 0);
    HLT_weight_stats_up = HLTWeightCal(jets_HT, jets_6pt, bjetsM_num, triggerHist1b, triggerHist2b, triggerHist3b, m_isData, 1);
    HLT_weight_stats_down = HLTWeightCal(jets_HT, jets_6pt, bjetsM_num, triggerHist1b, triggerHist2b, triggerHist3b, m_isData, 2);

    Bool_t ifFR = kFALSE;
    if(e->tausF_jetPt.GetSize()>0){
        Double_t errUp, errDown, nominal;
        Int_t tauProng =  e->tausF_decayMode.At(0)/5 + 1 ;
        tauProng = tauProng==1? 1 : 3;
        ifFR = TTTT::getFRandError(m_graphs, std::abs(e->tausF_jetEta.At(0)), tauProng, e->tausF_jetPt.At(0), nominal, errDown, errUp);
        if (!ifFR)
            {
                std::cout<<"!!!FR not get<<\n";
                std::cout<<"eta="<<e->tausF_jetEta.At(0)<<" prong="<<tauProng<<" pt="<<e->tausF_jetPt.At(0)<<"\n";
            }
        FR_weight = nominal / (1. - nominal);
        FR_weight_up = (nominal+errUp)/(1. - (nominal+errUp));
        FR_weight_down = (nominal-errDown)/(1. - (nominal-errDown));
        // std::cout<<"FR_weight="<<FR_weight<<" FR_weight_up="<<FR_weight_up<<" FR_weight_down="<<FR_weight_down<<"\n";
    }

};

void WeightVarMaker::clearBranch()
{ //??? derived class should also have a clearBranch()

    FR_weight = -99;
    FR_weight_up = -99;
    FR_weight_down = -99;

    btagWPMT_weight = 1.;
    btagWPMT_weight_up = 1.;
    btagWPMT_weight_down = 1.;
    btagWPMT_weight_correlated_up = 1.;
    btagWPMT_weight_correlated_down = 1.;
    btagWPMT_weight_uncorrelated_up = 1.;
    btagWPMT_weight_uncorrelated_down = 1.;

    pdfWeight_up_ = 1.;
    pdfWeight_down_ = 1.;
    pdfWeightAlphaS_up_ = 1.;
    pdfWeightAlphaS_down_ = 1.;

    
};

void WeightVarMaker::reportEntry(TString className){
    if(m_entry==0){
        std::cout<<"running "<<className<<"\n";
    }
    m_entry++;
}

WeightVarMaker::~WeightVarMaker(){};